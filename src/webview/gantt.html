<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'none';
    img-src {{cspSource}} https: data:;
    style-src {{cspSource}} 'unsafe-inline' https:;
    script-src 'nonce-{{nonce}}' https:;
  " />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://unpkg.com/frappe-gantt@1.0.4/dist/frappe-gantt.css" />
  <style>
    body { font-family: sans-serif; padding: 10px; }
    #gantt { height: 520px; border: 1px solid #ddd; border-radius: 8px; overflow: auto; }
    .muted { color: #666; }
    .filters { margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
    .filters label { font-weight: 500; }
    .filters select { padding: 4px 8px; border-radius: 4px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script nonce="{{nonce}}" src="https://unpkg.com/frappe-gantt@1.0.4/dist/frappe-gantt.umd.js"></script>
  <script nonce="{{nonce}}" src="https://unpkg.com/vue@3/dist/vue.runtime.global.prod.js"></script>
  <script nonce="{{nonce}}">
    const { createApp, ref, computed, onMounted, h } = Vue;
    const vscode = acquireVsCodeApi();

    const initialTasks = {{initialTasks}};

    createApp({
      setup() {
        const allTasks = ref([]);
        const assignedFilter = ref('');
        const categoryFilter = ref('');
        const status = ref('');
        let gantt = null;

        const assignedOptions = computed(() => {
          return [...new Set(allTasks.value.map(t => t.assigned).filter(Boolean))].sort();
        });

        const categoryOptions = computed(() => {
          return [...new Set(allTasks.value.map(t => t.category).filter(Boolean))].sort();
        });

        const filteredTasks = computed(() => {
          return allTasks.value.filter(t => {
            if (assignedFilter.value && t.assigned !== assignedFilter.value) return false;
            if (categoryFilter.value && t.category !== categoryFilter.value) return false;
            return true;
          });
        });

        function doRenderGantt() {
          const el = document.querySelector("#gantt");
          if (!el) return;
          el.innerHTML = "";

          const tasks = filteredTasks.value;
          if (!tasks || tasks.length === 0) {
            status.value = "No hay tareas validas.";
            return;
          }

          status.value = "Actualizado: " + new Date().toLocaleTimeString();

          gantt = new Gantt("#gantt", tasks, {
            view_mode: "Day",
            infinite_padding: false,
            popup: function({ task }) {
              return `
              <div style="padding: 4px; color:#666;">
                <div style="font-weight: 700; margin-bottom: 4px;">${task.name}</div>
                <div style="font-size: 12px; margin-bottom: 6px;">
                  ${task.start} â†’ ${task.end}
                </div>
                ${task.category ? `<div><b>Categoria:</b> ${task.category}</div>` : ''}
                ${task.assigned ? `<div><b>Responsable:</b> ${task.assigned}</div>` : ''}
                <div><b>Progreso:</b> ${task.progress}%</div>
              </div>
              `;
            }
          });
        }

        function setTasks(tasks) {
          const prevAssigned = assignedFilter.value;
          const prevCategory = categoryFilter.value;

          allTasks.value = tasks;

          if (!assignedOptions.value.includes(prevAssigned)) {
            assignedFilter.value = '';
          }
          if (!categoryOptions.value.includes(prevCategory)) {
            categoryFilter.value = '';
          }

          doRenderGantt();
        }

        onMounted(() => {
          setTasks(initialTasks);

          window.addEventListener("message", (event) => {
            const msg = event.data;
            if (msg?.type === "update") {
              setTasks(msg.tasks);
            }
            if (msg?.type === "error") {
              status.value = msg.message || "Error";
            }
          });
        });

        return () => h('div', [
          h('h2', 'Gantt desde CSV'),
          h('div', { class: 'filters' }, [
            h('label', { for: 'assignedFilter' }, 'Responsable:'),
            h('select', {
              id: 'assignedFilter',
              value: assignedFilter.value,
              onChange: (e) => { assignedFilter.value = e.target.value; doRenderGantt(); }
            }, [
              h('option', { value: '' }, 'Todos'),
              ...assignedOptions.value.map(a => h('option', { key: a, value: a }, a))
            ]),
            h('label', { for: 'categoryFilter' }, 'Categoria:'),
            h('select', {
              id: 'categoryFilter',
              value: categoryFilter.value,
              onChange: (e) => { categoryFilter.value = e.target.value; doRenderGantt(); }
            }, [
              h('option', { value: '' }, 'Todas'),
              ...categoryOptions.value.map(c => h('option', { key: c, value: c }, c))
            ])
          ]),
          h('p', { class: 'muted' }, status.value),
          h('div', { id: 'gantt' })
        ]);
      }
    }).mount('#app');
  </script>
</body>
</html>
